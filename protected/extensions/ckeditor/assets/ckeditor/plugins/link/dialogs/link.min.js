CKEDITOR.dialog.add("link",function(X){var V,U;function S(b){return b.replace(/'/g,"\\$&")}function N(i){var j,m=V,l,k;j=[U,"("];for(var h=0;h<m.length;h++){l=m[h].toLowerCase(),k=i[l],0<h&&j.push(","),j.push("'",k?S(encodeURIComponent(i[l])):"","'")}j.push(")");return j.join("")}function M(b){for(var h,k=b.length,j=[],i=0;i<k;i++){h=b.charCodeAt(i),j.push(h)}return"String.fromCharCode("+j.join(",")+")"}function K(b){return(b=b.getAttribute("class"))?b.replace(/\s*(?:cke_anchor_empty|cke_anchor)(?:\s*$)?/g,""):""}var I=CKEDITOR.plugins.link,Q=function(){var b=this.getDialog(),h=b.getContentElement("target","popupFeatures"),b=b.getContentElement("target","linkTargetName"),i=this.getValue();if(h&&b){switch(h=h.getElement(),h.hide(),b.setValue(""),i){case"frame":b.setLabel(X.lang.link.targetFrameName);b.getElement().show();break;case"popup":h.show();b.setLabel(X.lang.link.targetPopupName);b.getElement().show();break;default:b.setValue(i),b.getElement().hide()}}},f=/^javascript:/,d=/^mailto:([^?]+)(?:\?(.+))?$/,c=/subject=([^;?:@&=$,\/]*)/,a=/body=([^;?:@&=$,\/]*)/,T=/^#(.*)$/,R=/^((?:http|https|ftp|news):\/\/)?(.*)$/,P=/^(_(?:self|top|parent|blank))$/,O=/^javascript:void\(location\.href='mailto:'\+String\.fromCharCode\(([^)]+)\)(?:\+'(.*)')?\)$/,L=/^javascript:([^(]+)\(([^)]+)\)$/,J=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/,g=/(?:^|,)([^=]+)=(\d+|yes|no)/gi,e=function(i,j){var n=j&&(j.data("cke-saved-href")||j.getAttribute("href"))||"",m,l,h={};n.match(f)&&("encode"==W?n=n.replace(O,function(p,o,q){return"mailto:"+String.fromCharCode.apply(String,o.split(","))+(q&&q.replace(/\\'/g,"'"))}):W&&n.replace(L,function(b,t,s){if(t==U){h.type="email";for(var b=h.email={},t=/(^')|('$)/g,s=s.match(/[^,\s]+/g),r=s.length,p,q,o=0;o<r;o++){p=decodeURIComponent,q=s[o].replace(t,"").replace(/\\'/g,"'"),q=p(q),p=V[o].toLowerCase(),b[p]=q}b.address=[b.name,b.domain].join("@")}}));if(!h.type){if(m=n.match(T)){h.type="anchor",h.anchor={},h.anchor.name=h.anchor.id=m[1]}else{if(m=n.match(d)){l=n.match(c);n=n.match(a);h.type="email";var k=h.email={};k.address=m[1];l&&(k.subject=decodeURIComponent(l[1]));n&&(k.body=decodeURIComponent(n[1]))}else{n&&(l=n.match(R))?(h.type="url",h.url={},h.url.protocol=l[1],h.url.url=l[2]):h.type="url"}}}if(j){m=j.getAttribute("target");h.target={};h.adv={};if(m){m.match(P)?h.target.type=h.target.name=m:(h.target.type="frame",h.target.name=m)}else{if(m=(m=j.data("cke-pa-onclick")||j.getAttribute("onclick"))&&m.match(J)){h.target.type="popup";for(h.target.name=m[1];n=g.exec(m[2]);){("yes"==n[2]||"1"==n[2])&&!(n[1] in {height:1,width:1,top:1,left:1})?h.target[n[1]]=!0:isFinite(n[2])&&(h.target[n[1]]=n[2])}}}m=function(b,p){var o=j.getAttribute(p);null!==o&&(h.adv[b]=o||"")};m("advId","id");m("advLangDir","dir");m("advAccessKey","accessKey");h.adv.advName=j.data("cke-saved-name")||j.getAttribute("name")||"";m("advLangCode","lang");m("advTabIndex","tabindex");m("advTitle","title");m("advContentType","type");CKEDITOR.plugins.link.synAnchorSelector?h.adv.advCSSClasses=K(j):m("advCSSClasses","class");m("advCharset","charset");m("advStyles","style");m("advRel","rel")}h.anchors=CKEDITOR.plugins.link.getEditorAnchors(i);this._.selectedElement=j;return h},ab=function(b){b.target&&this.setValue(b.target[this.id]||"")},aa=function(b){b.adv&&this.setValue(b.adv[this.id]||"")},Z=function(b){b.target||(b.target={});b.target[this.id]=this.getValue()||""},Y=function(b){b.adv||(b.adv={});b.adv[this.id]=this.getValue()||""},W=X.config.emailProtection||"";W&&"encode"!=W&&(U=V=void 0,W.replace(/^([^(]+)\(([^)]+)\)$/,function(i,h,j){U=h;V=[];j.replace(/[^,\s]+/g,function(b){V.push(b)})}));var ac=X.lang.common,ad=X.lang.link;return{title:ad.title,minWidth:350,minHeight:230,contents:[{id:"info",label:ad.info,title:ad.info,elements:[{id:"linkType",type:"select",label:ad.type,"default":"url",items:[[ad.toUrl,"url"],[ad.toAnchor,"anchor"],[ad.toEmail,"email"]],onChange:function(){var i=this.getDialog(),h=["urlOptions","anchorOptions","emailOptions"],l=this.getValue(),k=i.definition.getContents("upload"),k=k&&k.hidden;if(l=="url"){X.config.linkShowTargetTab&&i.showPage("target");k||i.showPage("upload")}else{i.hidePage("target");k||i.hidePage("upload")}for(k=0;k<h.length;k++){var j=i.getContentElement("info",h[k]);if(j){j=j.getElement().getParent().getParent();h[k]==l+"Options"?j.show():j.hide()}}i.layout()},setup:function(b){b.type&&this.setValue(b.type)},commit:function(b){b.type=this.getValue()}},{type:"vbox",id:"urlOptions",children:[{type:"hbox",widths:["25%","75%"],children:[{id:"protocol",type:"select",label:ac.protocol,"default":"http://",items:[["http://","http://"],["https://","https://"],["ftp://","ftp://"],["news://","news://"],[ad.other,""]],setup:function(b){b.url&&this.setValue(b.url.protocol||"")},commit:function(b){if(!b.url){b.url={}}b.url.protocol=this.getValue()}},{type:"text",id:"url",label:ac.url,required:!0,onLoad:function(){this.allowOnChange=true},onKeyUp:function(){this.allowOnChange=false;var i=this.getDialog().getContentElement("info","protocol"),h=this.getValue(),k=/^((javascript:)|[#\/\.\?])/i,j=/^(http|https|ftp|news):\/\/(?=.)/i.exec(h);if(j){this.setValue(h.substr(j[0].length));i.setValue(j[0].toLowerCase())}else{k.test(h)&&i.setValue("")}this.allowOnChange=true},onChange:function(){if(this.allowOnChange){this.onKeyUp()}},validate:function(){var b=this.getDialog();if(b.getContentElement("info","linkType")&&b.getValueOf("info","linkType")!="url"){return true}if(/javascript\:/.test(this.getValue())){alert(ac.invalidValue);return false}return this.getDialog().fakeObj?true:CKEDITOR.dialog.validate.notEmpty(ad.noUrl).apply(this)},setup:function(b){this.allowOnChange=false;b.url&&this.setValue(b.url.url);this.allowOnChange=true},commit:function(b){this.onChange();if(!b.url){b.url={}}b.url.url=this.getValue();this.allowOnChange=false}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().show()}},{type:"button",id:"browse",hidden:"true",filebrowser:"info:url",label:ac.browseServer}]},{type:"vbox",id:"anchorOptions",width:260,align:"center",padding:0,children:[{type:"fieldset",id:"selectAnchorText",label:ad.selectAnchor,setup:function(b){b.anchors.length>0?this.getElement().show():this.getElement().hide()},children:[{type:"hbox",id:"selectAnchor",children:[{type:"select",id:"anchorName","default":"",label:ad.anchorName,style:"width: 100%;",items:[[""]],setup:function(i){this.clear();this.add("");for(var h=0;h<i.anchors.length;h++){i.anchors[h].name&&this.add(i.anchors[h].name)}i.anchor&&this.setValue(i.anchor.name);(i=this.getDialog().getContentElement("info","linkType"))&&i.getValue()=="email"&&this.focus()},commit:function(b){if(!b.anchor){b.anchor={}}b.anchor.name=this.getValue()}},{type:"select",id:"anchorId","default":"",label:ad.anchorId,style:"width: 100%;",items:[[""]],setup:function(i){this.clear();this.add("");for(var h=0;h<i.anchors.length;h++){i.anchors[h].id&&this.add(i.anchors[h].id)}i.anchor&&this.setValue(i.anchor.id)},commit:function(b){if(!b.anchor){b.anchor={}}b.anchor.id=this.getValue()}}],setup:function(b){b.anchors.length>0?this.getElement().show():this.getElement().hide()}}]},{type:"html",id:"noAnchors",style:"text-align: center;",html:'<div role="note" tabIndex="-1">'+CKEDITOR.tools.htmlEncode(ad.noAnchors)+"</div>",focus:!0,setup:function(b){b.anchors.length<1?this.getElement().show():this.getElement().hide()}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().hide()}},{type:"vbox",id:"emailOptions",padding:1,children:[{type:"text",id:"emailAddress",label:ad.emailAddress,required:!0,validate:function(){var b=this.getDialog();return !b.getContentElement("info","linkType")||b.getValueOf("info","linkType")!="email"?true:CKEDITOR.dialog.validate.notEmpty(ad.noEmail).apply(this)},setup:function(b){b.email&&this.setValue(b.email.address);(b=this.getDialog().getContentElement("info","linkType"))&&b.getValue()=="email"&&this.select()},commit:function(b){if(!b.email){b.email={}}b.email.address=this.getValue()}},{type:"text",id:"emailSubject",label:ad.emailSubject,setup:function(b){b.email&&this.setValue(b.email.subject)},commit:function(b){if(!b.email){b.email={}}b.email.subject=this.getValue()}},{type:"textarea",id:"emailBody",label:ad.emailBody,rows:3,"default":"",setup:function(b){b.email&&this.setValue(b.email.body)},commit:function(b){if(!b.email){b.email={}}b.email.body=this.getValue()}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().hide()}}]},{id:"target",requiredContent:"a[target]",label:ad.target,title:ad.target,elements:[{type:"hbox",widths:["50%","50%"],children:[{type:"select",id:"linkTargetType",label:ac.target,"default":"notSet",style:"width : 100%;",items:[[ac.notSet,"notSet"],[ad.targetFrame,"frame"],[ad.targetPopup,"popup"],[ac.targetNew,"_blank"],[ac.targetTop,"_top"],[ac.targetSelf,"_self"],[ac.targetParent,"_parent"]],onChange:Q,setup:function(b){b.target&&this.setValue(b.target.type||"notSet");Q.call(this)},commit:function(b){if(!b.target){b.target={}}b.target.type=this.getValue()}},{type:"text",id:"linkTargetName",label:ad.targetFrameName,"default":"",setup:function(b){b.target&&this.setValue(b.target.name)},commit:function(b){if(!b.target){b.target={}}b.target.name=this.getValue().replace(/\W/gi,"")}}]},{type:"vbox",width:"100%",align:"center",padding:2,id:"popupFeatures",children:[{type:"fieldset",label:ad.popupFeatures,children:[{type:"hbox",children:[{type:"checkbox",id:"resizable",label:ad.popupResizable,setup:ab,commit:Z},{type:"checkbox",id:"status",label:ad.popupStatusBar,setup:ab,commit:Z}]},{type:"hbox",children:[{type:"checkbox",id:"location",label:ad.popupLocationBar,setup:ab,commit:Z},{type:"checkbox",id:"toolbar",label:ad.popupToolbar,setup:ab,commit:Z}]},{type:"hbox",children:[{type:"checkbox",id:"menubar",label:ad.popupMenuBar,setup:ab,commit:Z},{type:"checkbox",id:"fullscreen",label:ad.popupFullScreen,setup:ab,commit:Z}]},{type:"hbox",children:[{type:"checkbox",id:"scrollbars",label:ad.popupScrollBars,setup:ab,commit:Z},{type:"checkbox",id:"dependent",label:ad.popupDependent,setup:ab,commit:Z}]},{type:"hbox",children:[{type:"text",widths:["50%","50%"],labelLayout:"horizontal",label:ac.width,id:"width",setup:ab,commit:Z},{type:"text",labelLayout:"horizontal",widths:["50%","50%"],label:ad.popupLeft,id:"left",setup:ab,commit:Z}]},{type:"hbox",children:[{type:"text",labelLayout:"horizontal",widths:["50%","50%"],label:ac.height,id:"height",setup:ab,commit:Z},{type:"text",labelLayout:"horizontal",label:ad.popupTop,widths:["50%","50%"],id:"top",setup:ab,commit:Z}]}]}]}]},{id:"upload",label:ad.upload,title:ad.upload,hidden:!0,filebrowser:"uploadButton",elements:[{type:"file",id:"upload",label:ac.upload,style:"height:40px",size:29},{type:"fileButton",id:"uploadButton",label:ac.uploadSubmit,filebrowser:"info:url","for":["upload","upload"]}]},{id:"advanced",label:ad.advanced,title:ad.advanced,elements:[{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",id:"advId",requiredContent:"a[id]",label:ad.id,setup:aa,commit:Y},{type:"select",id:"advLangDir",requiredContent:"a[dir]",label:ad.langDir,"default":"",style:"width:110px",items:[[ac.notSet,""],[ad.langDirLTR,"ltr"],[ad.langDirRTL,"rtl"]],setup:aa,commit:Y},{type:"text",id:"advAccessKey",requiredContent:"a[accesskey]",width:"80px",label:ad.acccessKey,maxLength:1,setup:aa,commit:Y}]},{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",label:ad.name,id:"advName",requiredContent:"a[name]",setup:aa,commit:Y},{type:"text",label:ad.langCode,id:"advLangCode",requiredContent:"a[lang]",width:"110px","default":"",setup:aa,commit:Y},{type:"text",label:ad.tabIndex,id:"advTabIndex",requiredContent:"a[tabindex]",width:"80px",maxLength:5,setup:aa,commit:Y}]}]},{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:ad.advisoryTitle,requiredContent:"a[title]","default":"",id:"advTitle",setup:aa,commit:Y},{type:"text",label:ad.advisoryContentType,requiredContent:"a[type]","default":"",id:"advContentType",setup:aa,commit:Y}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:ad.cssClasses,requiredContent:"a(cke-xyz)","default":"",id:"advCSSClasses",setup:aa,commit:Y},{type:"text",label:ad.charset,requiredContent:"a[charset]","default":"",id:"advCharset",setup:aa,commit:Y}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:ad.rel,requiredContent:"a[rel]","default":"",id:"advRel",setup:aa,commit:Y},{type:"text",label:ad.styles,requiredContent:"a{cke-xyz}","default":"",id:"advStyles",validate:CKEDITOR.dialog.validate.inlineStyle(X.lang.common.invalidInlineStyle),setup:aa,commit:Y}]}]}]}],onShow:function(){var i=this.getParentEditor(),h=i.getSelection(),j=null;(j=I.getSelectedLink(i))&&j.hasAttribute("href")?h.getSelectedElement()||h.selectElement(j):j=null;this.setupContent(e.apply(this,[i,j]))},onOk:function(){var s={},r=[],q={},p=this.getParentEditor();this.commitContent(q);switch(q.type||"url"){case"url":var o=q.url&&q.url.protocol!=void 0?q.url.protocol:"http://",m=q.url&&CKEDITOR.tools.trim(q.url.url)||"";s["data-cke-saved-href"]=m.indexOf("/")===0?m:o+m;break;case"anchor":o=q.anchor&&q.anchor.id;s["data-cke-saved-href"]="#"+(q.anchor&&q.anchor.name||o||"");break;case"email":var n=q.email,o=n.address;switch(W){case"":case"encode":var m=encodeURIComponent(n.subject||""),l=encodeURIComponent(n.body||""),n=[];m&&n.push("subject="+m);l&&n.push("body="+l);n=n.length?"?"+n.join("&"):"";if(W=="encode"){o=["javascript:void(location.href='mailto:'+",M(o)];n&&o.push("+'",S(n),"'");o.push(")")}else{o=["mailto:",o,n]}break;default:o=o.split("@",2);n.name=o[0];n.domain=o[1];o=["javascript:",N(n)]}s["data-cke-saved-href"]=o.join("")}if(q.target){if(q.target.type=="popup"){for(var o=["window.open(this.href, '",q.target.name||"","', '"],k=["resizable","status","location","toolbar","menubar","fullscreen","scrollbars","dependent"],m=k.length,n=function(b){q.target[b]&&k.push(b+"="+q.target[b])},l=0;l<m;l++){k[l]=k[l]+(q.target[k[l]]?"=yes":"=no")}n("width");n("left");n("height");n("top");o.push(k.join(","),"'); return false;");s["data-cke-pa-onclick"]=o.join("");r.push("target")}else{q.target.type!="notSet"&&q.target.name?s.target=q.target.name:r.push("target");r.push("data-cke-pa-onclick","onclick")}}if(q.adv){o=function(i,h){var b=q.adv[i];b?s[h]=b:r.push(h)};o("advId","id");o("advLangDir","dir");o("advAccessKey","accessKey");q.adv.advName?s.name=s["data-cke-saved-name"]=q.adv.advName:r=r.concat(["data-cke-saved-name","name"]);o("advLangCode","lang");o("advTabIndex","tabindex");o("advTitle","title");o("advContentType","type");o("advCSSClasses","class");o("advCharset","charset");o("advStyles","style");o("advRel","rel")}o=p.getSelection();s.href=s["data-cke-saved-href"];if(this._.selectedElement){p=this._.selectedElement;m=p.data("cke-saved-href");n=p.getHtml();p.setAttributes(s);p.removeAttributes(r);q.adv&&(q.adv.advName&&CKEDITOR.plugins.link.synAnchorSelector)&&p.addClass(p.getChildCount()?"cke_anchor":"cke_anchor_empty");if(m==n||q.type=="email"&&n.indexOf("@")!=-1){p.setHtml(q.type=="email"?q.email.address:s["data-cke-saved-href"]);o.selectElement(p)}delete this._.selectedElement}else{o=o.getRanges()[0];if(o.collapsed){p=new CKEDITOR.dom.text(q.type=="email"?q.email.address:s["data-cke-saved-href"],p.document);o.insertNode(p);o.selectNodeContents(p)}p=new CKEDITOR.style({element:"a",attributes:s});p.type=CKEDITOR.STYLE_INLINE;p.applyToRange(o);o.select()}},onLoad:function(){X.config.linkShowAdvancedTab||this.hidePage("advanced");X.config.linkShowTargetTab||this.hidePage("target")},onFocus:function(){var b=this.getContentElement("info","linkType");if(b&&b.getValue()=="url"){b=this.getContentElement("info","url");b.select()}}}});